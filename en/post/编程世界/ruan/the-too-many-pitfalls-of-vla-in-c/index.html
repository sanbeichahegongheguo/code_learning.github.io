<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>The (too) many pitfalls of VLA in C - 英文文章</title>
  
<link rel="alternate" hreflang="" href="/post/%E7%BC%96%E7%A8%8B%E4%B8%96%E7%95%8C/ruan/the-too-many-pitfalls-of-vla-in-c/" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="总舵主" />
  <meta name="description" content="2021-07-05 | Categories: programming | Tags: C advice
 It generates much more code, and much slower code (and more fragile code), than just using a fixed key size would have done.
~ Linus Torvalds
" />







<meta name="generator" content="Hugo 0.88.1" />


<link rel="canonical" href="/en/post/%E7%BC%96%E7%A8%8B%E4%B8%96%E7%95%8C/ruan/the-too-many-pitfalls-of-vla-in-c/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="The (too) many pitfalls of VLA in C" />
<meta property="og:description" content="2021-07-05 | Categories: programming | Tags: C advice

It generates much more code, and much slower code (and more fragile code), than just using a fixed key size would have done.
~ Linus Torvalds
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/post/%E7%BC%96%E7%A8%8B%E4%B8%96%E7%95%8C/ruan/the-too-many-pitfalls-of-vla-in-c/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-01-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-01-31T00:00:00+00:00" /><meta property="og:site_name" content="英文文章" />

<meta itemprop="name" content="The (too) many pitfalls of VLA in C">
<meta itemprop="description" content="2021-07-05 | Categories: programming | Tags: C advice

It generates much more code, and much slower code (and more fragile code), than just using a fixed key size would have done.
~ Linus Torvalds
"><meta itemprop="datePublished" content="2018-01-31T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-01-31T00:00:00+00:00" />
<meta itemprop="wordCount" content="2349">
<meta itemprop="keywords" content="C,ruan,翻译," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The (too) many pitfalls of VLA in C"/>
<meta name="twitter:description" content="2021-07-05 | Categories: programming | Tags: C advice

It generates much more code, and much slower code (and more fragile code), than just using a fixed key size would have done.
~ Linus Torvalds
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/en/" class="logo">火山灰</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="en/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="en/post/">时间轴</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="en/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="en/categories/">归档</a>
          
        
      </li>
    <li class="mobile-menu-item">
        
        <div class="mobile-menu-parent mobile-menu-item-lang">
          <span class="mobile-submenu-open"></span>
          <a href="#">
            
            <i class="iconfont">
              
&lt;?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg width="100%" height="100%" version="1.1"
xmlns="http://www.w3.org/2000/svg">

<path d="M153 334
C153 334 151 334 151 334
C151 339 153 344 156 344
C164 344 171 339 171 334
C171 322 164 314 156 314
C142 314 131 322 131 334
C131 350 142 364 156 364
C175 364 191 350 191 334
C191 311 175 294 156 294
C131 294 111 311 111 334
C111 361 131 384 156 384
C186 384 211 361 211 334
C211 300 186 274 156 274"
style="fill:white;stroke:red;stroke-width:2"/>

</svg>

            </i>
            Language
          </a>
        </div>
        <ul class="mobile-submenu-list">
          
            <li>
              
                <a href="/"></a>
              
            </li>
          
            <li>
              
                <a href="/en/"><strong></strong></a>
              
            </li>
          
        </ul>
      </li>

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/en/" class="logo">
    
      火山灰
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="en/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="en/post/">时间轴</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="en/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="en/categories/">归档</a>
          

        

      </li>
    

    
    <li class="menu-item">
        
        <a class="menu-item-link menu-parent menu-item-lang" href="#">
          
          <i class="iconfont">
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M912.569234 73.142857a88.429714 88.429714 0 0 1 88.576 89.161143v296.557714C1001.145234 732.562286 782.301806 950.857143 510.28352 950.857143A489.837714 489.837714 0 0 1 18.288091 458.861714V162.304A90.002286 90.002286 0 0 1 107.449234 73.142857h805.156572z m-402.285714 608a68.388571 68.388571 0 0 0 46.848-18.870857l230.838857-221.696a68.022857 68.022857 0 0 0 21.138286-48.566857 67.547429 67.547429 0 0 0-114.285714-48.566857l-184.576 177.152-184.576-177.152a67.328 67.328 0 0 0-46.299429-18.870857 67.547429 67.547429 0 0 0-46.884571 116.004571l231.424 221.696c11.995429 11.995429 29.147429 18.870857 46.299428 18.870857z"></path>
</svg>

          </i>
          
        </a>
        <ul class="submenu">
          
            
              <li>
                <a href="/">zh-cn</a>
              </li>
            
          
            
              <li>
                <a href="/en/">en</a>
              </li>
            
          
        </ul>
      </li>
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">The (too) many pitfalls of VLA in C</h1>
      
<div class="post-meta">
  
  <div><a href="/post/%E7%BC%96%E7%A8%8B%E4%B8%96%E7%95%8C/ruan/the-too-many-pitfalls-of-vla-in-c/">中文阅读: C语言中可变数组（VLA）有太多陷阱</a></div>
  
</div>

      <div class="post-meta">
        <time datetime="2018-01-31" class="post-time">
          2018-01-31
        </time>
        <div class="post-category">
            <a href="/en/categories/%E7%BC%96%E7%A8%8B%E4%B8%96%E7%95%8C/"> 编程世界 </a>
            
          </div>
        <span class="more-meta"> 2349 words </span>
          <span class="more-meta"> 5 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#allocation-on-stack">Allocation on stack</a>
      <ul>
        <li><a href="#worst-of-it-is">Worst of it is…</a></li>
        <li><a href="#so-how-to-fix-this-example">So how to fix this example?</a></li>
      </ul>
    </li>
    <li><a href="#creation-by-accident">Creation by accident</a></li>
    <li><a href="#slower-than-fixed-size">Slower than fixed size</a></li>
    <li><a href="#no-initialization">No initialization</a></li>
    <li><a href="#mess-for-compiler-writers">Mess for compiler writers</a></li>
    <li><a href="#reduced-portability">Reduced portability</a></li>
    <li><a href="#nitpick-breaking-conventions">(nitpick) Breaking conventions</a></li>
    <li><a href="#-kinda-useful-in-one-case">… kinda useful in one case</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>2021-07-05 | Categories: <a href="https://blog.joren.ga/categories/#programming">programming</a> | Tags: <a href="https://blog.joren.ga/categories/#C">C</a> <a href="https://blog.joren.ga/categories/#advice">advice</a></p>
<blockquote>
<p>It generates much more code, and much <em>slower</em> code (and more fragile code), than just using a fixed key size would have done.</p>
<p>~ <a href="https://lkml.org/lkml/2018/3/7/621">Linus Torvalds</a></p>
</blockquote>
<p><em>VLA</em> is an acronym of <strong>variable-length array</strong>, which is an <strong>array</strong> (actual array, not just block of memory which can act like one) that have size (at least one dimension) determined during runtime (instead of at compile time).</p>
<p>Languages supporting VLAs in one form or another include: Ada, Algol 68, APL, C, C#, COBOL, Fortran, J and Object Pascal. As you may notice, beside C and C#, those aren&rsquo;t languages one would call mainstream nowadays.</p>
<p>VLAs were introduced with the revision C99 of the C standard. At first glance they seem convenient and efficient, but it&rsquo;s just an illusion. In reality they are just sources of constant issues. Truly a stain on otherwise really good revision.</p>
<p>As you could have guessed by the quote at the beginning, project which used to rely on VLA quite extensively is nothing else than Linux kernel. Maintainers spent a lot of effort to get rid of all VLA and as of version 4.20 (year 2018) it&rsquo;s completely VLA-free.</p>
<h2 id="allocation-on-stack">Allocation on stack</h2>
<p>VLAs are usually allocated on stack and this is the source of the most of the problems. Let&rsquo;s consider a painfully simple, very favourable to VLA, example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">#include &lt;stdio.h&gt;

int main(void) {
    int n;
    scanf(&#34;%d&#34;, &amp;n);
    long double arr[n];
    printf(&#34;%Lf&#34;, arr[0]);
    return 0;
}
</code></pre></td></tr></table>
</div>
</div><p>As we can see, it takes a number from user then makes array of that size. Compile and try it. Check how big values you can input before getting segfault caused by stack overflow. In my case, it was around half a million. With primitive type! Imagine what would be the limit for structure! Or what if it wasn&rsquo;t just <code>main()</code>? Maybe a recursive function? The limit shrinks tremendously.</p>
<p>And you don&rsquo;t have any (portable, standard) way to react after a stack overflow - the program already crashed, you lost control. So you either need to make elaborate checks before declaring an array or betting that user won&rsquo;t input too large values (I think we can already guess the outcome of such gamble).</p>
<p>So the programmer <strong>must</strong> ensure that VLA size doesn&rsquo;t exceed some safe maximum, but in reality, if you know safe maximum, there is rarely any reason for not using it always.</p>
<h3 id="worst-of-it-is">Worst of it is…</h3>
<p>… that segfault is actually one of the best outcomes of improperly handled VLA. The worst case is an exploitable vulnerability, where attacker may choose a value that causes an array to overlap with other allocations, giving them control over those values as well. A security nightmare.</p>
<p>At the cost of further drop of efficiency, in GCC you can enable <code>-fstack-clash-protection</code> option. It adds <em>extra</em> instructions around variable length stack memory allocations to probe each page of memory at allocation time. This mitigates stack-clash attacks by ensuring all stack memory allocations are valid or by throwing a segfault if they are not, thus turning a possible code-execution attack into a denial of service.</p>
<h3 id="so-how-to-fix-this-example">So how to fix this example?</h3>
<p>What if I need to let user define size and creating ridiculously large fixed array would be too wasteful? It&rsquo;s simple - use <code>malloc()</code>!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main(void) {
    int n;
    scanf(&#34;%d&#34;, &amp;n);
    long double* arr = malloc(n * sizeof(*arr));
    printf(&#34;%Lf&#34;, arr[0]);
    free(arr);
    return 0;
}
</code></pre></td></tr></table>
</div>
</div><p>In this case I was able to input over 1.3 <strong>billion</strong> on my machine before segfault. Almost 2500 times larger size! But I still got the segfault, right? Well, the difference is in possibility of checking the value returned by <code>malloc()</code> and thus being able to, for example, inform the user about the error:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">    long double* arr = malloc(n * sizeof(*arr));
    if (arr == NULL) {
        perror(&#34;malloc()&#34;); // output: &#34;malloc(): Cannot allocate memory&#34;
    }
</code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ve encountered a counterargument, that as C is often used as a systems/embedded language, there are situations where using <code>malloc()</code> may not even be possible.</p>
<p><strong>Sigh</strong> I&rsquo;m basically going to repeat myself here, but it is really important.</p>
<p>On such device you&rsquo;re not going to have a lot of stack either. So instead of dynamically allocating on stack, you should determine how much you need and just always use that fixed amount.</p>
<p>When using VLA on system with small amounts of stack, it&rsquo;s really easy to make something which seems to work, but which blows your stack if your function gets called from a deep call stack combined with the large amount of data.</p>
<p>If you always allocate fixed amounts of stack space everywhere, and you test it, you know you&rsquo;re good. If you dynamically allocate on stack, you have to test all your code paths with all the largest sizes of allocated space, which is much harder and much easier to make a mistake. Don&rsquo;t make it even easier to shoot yourself in the foot for no real advantage.</p>
<h2 id="creation-by-accident">Creation by accident</h2>
<p>Unlike most other dangerous C functionality, VLA doesn&rsquo;t have the barrier of being not known. Many newbies learn to use them via trial and error, but don&rsquo;t learn about the pitfalls. Sometimes even an experiences programmer will make an mistake and create an VLA when not intended. The following will silently create a VLA when it&rsquo;s clearly not necessary:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">const int n = 10;
int A[n];
</code></pre></td></tr></table>
</div>
</div><p>Thankfully, any half-decent compiler would notice and optimize VLA away, but… what if it doesn&rsquo;t notice? Or what if for some reason (safety?) the optimizations were not turned on? But it surely isn&rsquo;t so much worse, right? Well…</p>
<h2 id="slower-than-fixed-size">Slower than fixed size</h2>
<p>Without compiler optimizations a function with <a href="https://godbolt.org/z/c7nPvGGcP">VLA from previous example</a> will result in <strong>7 times</strong> more Assembly instructions than its <a href="https://godbolt.org/z/jx94vx84T">fixed size counterpart</a> before moving past the array definition (look at the body before <code>jmp .L5</code>). But it&rsquo;s without optimizations - with them the produced Assembly is exactly the same.</p>
<p>So <a href="https://godbolt.org/z/vnf174eej">an example where VLA isn&rsquo;t by mistake</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">#include &lt;stdio.h&gt;
void bar(int*, int);

#if 1 // 1 for VLA, 0 for VLA-free

void foo(int n) {
    int A[n];
    for (int i = n; i--;) {
        scanf(&#34;%d&#34;, &amp;A[i]);
    }
    bar(A, n);
}

#else

void foo(int n) {
    int A[1000];  // Let&#39;s make it bigger than 10! (or there won&#39;t be what to examine)
    for (int i = n; i--;) {
        scanf(&#34;%d&#34;, &amp;A[i]);
    }
    bar(A, n);
}

#endif

int main(void) {
    foo(10);
    return 0;
}

void bar(int* B, int n) {
    for (int i = n; i--;) {
        printf(&#34;%d %d&#34;, i, B[i]);
    }
}
</code></pre></td></tr></table>
</div>
</div><p>For our educational purposes in this example, <code>-O1</code> level of optimisation will work best (as Assembly will be more clear and <code>-O2</code> won&rsquo;t help VLA&rsquo;s case here really much).</p>
<p>When we compile VLA version, before instructions corresponding to <code>for</code> loop, we get:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">push    rbp
mov     rbp, rsp
push    r14
push    r13
push    r12
push    rbx
mov     r13d, edi
movsx   r12, edi       ; here VLA &#34;starts&#34;...
sal     r12, 2         ;
lea     rax, [r12+15]  ;
and     rax, -16       ;
sub     rsp, rax       ;
mov     r14, rsp       ; ... and there &#34;ends&#34;
</code></pre></td></tr></table>
</div>
</div><p>VLA-free version on the other hand generates:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">push    r12
push    rbp
push    rbx
sub     rsp, 4000      ; this is caused by array definition
mov     r12d, edi
</code></pre></td></tr></table>
</div>
</div><p>So not only fixed array spawns less code, but also way simpler code. Why, VLA even causes more overhead at the beginning of the function. It&rsquo;s not so much more in the grand scheme of things, but it still isn&rsquo;t just a pointer bump.</p>
<p>But are those differences significant enough to care? <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=02361bc77888">Yes, they are</a>.</p>
<h2 id="no-initialization">No initialization</h2>
<p>To add more to the issue with inadvertent VLA, the following isn&rsquo;t allowed:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">int n = 10;
int A[n] = { 0 };
</code></pre></td></tr></table>
</div>
</div><p>Even with optimizations, initialisation isn&rsquo;t allowed for VLAs. So despite wanting fixed size array and compiler being technically able to provide one, it&rsquo;s won&rsquo;t work.</p>
<h2 id="mess-for-compiler-writers">Mess for compiler writers</h2>
<p>Few months ago I saved a <a href="https://www.reddit.com/r/C_Programming/comments/jz2213/are_vlas_bad_even_if_theyre_not_allocated_on_the/gdc3hz6">comment</a> on Reddit listing problems encountered with VLA from compiler writer perspective. I will cite it:</p>
<blockquote>
<ul>
<li>A VLA applies to a type, not an actual array. So you can create a <code>typedef</code> of a VLA type, which &ldquo;freezes&rdquo; the value of the expression used, even if elements of that expression change at the time the VLA type is applied</li>
<li>VLAs can occur inside blocks, and inside loops. This means allocating and deallocating variable-sized data on the stack, and either screwing up all the offsets, or needing to do things indirectly via pointers.</li>
<li>You can use <code>goto</code> into and out of blocks with active VLAs, with some things restricted and some not, but the compiler needs to keep track of the mess.</li>
<li>VLAs can be used with multi-dimensional arrays.</li>
<li>VLAs can be used as pointer targets (so no allocation is done, but it still needs to keep track of the variable size).</li>
<li>Some compilers allow VLAs inside structure definitions (I really have no idea how that works, or at what point the VLA size is frozen, so that all instances have the same VLA(s) sizes.)</li>
<li>A function can have dozens of VLAs active at any one time, with some being created or destroyed at different times, or conditionally, or in loops.</li>
<li><code>sizeof</code> needs to be specially implemented for VLAs, and all the necessary info (for actual VLAs, VLA-types, and hybrid VLA/fixed-size types and arrays and pointed-to VLAs).</li>
<li>&lsquo;VLA&rsquo; is also the term used for multi-dimensional array parameters, where the dimensions are passed by other parameters.</li>
<li>On Windows, with some compilers (GCC at least), declaring local arrays which make the stack frame size over 4 KiB, mean calling a special allocator (<code>__chkstk()</code>), as the stack can only grow a page at a time. When a VLA is declared, since the compiler doesn&rsquo;t know the size, it needs to call <code>__chkstk</code> for every such function, even if the size turns out to be small.</li>
</ul>
</blockquote>
<p>And believe me, if you take a stroll around some C forums you will see even more different complaints.</p>
<h2 id="reduced-portability">Reduced portability</h2>
<p>Due to all previously presented problems, some compiler providers decided to not fully support C99. The primary example is Microsoft with its MSVC. The C Standard&rsquo;s Committee also noticed the problem and with C11 revision VLAs were made optional (many would prefer <em>deprecated</em>).</p>
<p>That means code using a VLA won&rsquo;t necessarily be compiled by a C11 compiler, so you need to check whether it is supported with <code>__STDC_NO_VLA__</code> macro and make version without VLA as fallback. Wait… if you need to implement VLA-free version either way then what&rsquo;s the point of doubling the code and creating VLA in the first place?!</p>
<p>As a side note - C++ doesn&rsquo;t have VLA and nothing suggests it ever will. Not a dealbreaker, but still point against VLA in C.</p>
<h2 id="nitpick-breaking-conventions">(nitpick) Breaking conventions</h2>
<p>This one is more of a nitpick, but still another reason to dislike VLA. There is a widely used convention of first passing object then its parameters, what in terms of arrays means:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">void foo(int** arr, int n, int m) { /* arr[i][j] = ... */ }
</code></pre></td></tr></table>
</div>
</div><p>C99 specified that array sizes need to be parsed immediately when encountered within a function definition&rsquo;s parameter list, what means that when using VLA you cannot do an equivalent of the above:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">void foo(int arr[n][m], int n, int m) { /* arr[i][j] = ... */ } // INVALID!
</code></pre></td></tr></table>
</div>
</div><p>You either need to:</p>
<ul>
<li>
<p>break up with the convention:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">void foo(int n, int m, int arr[n][m]) { /* arr[i][j] = ... */ }
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>or make use of the obsolescent syntax:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">void foo(int[*][*], int, int);
void foo(arr, n, n)
    int n;
    int m;
    int arr[n][m]
{
    // arr[i][j] = ...
}
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="-kinda-useful-in-one-case">… kinda useful in one case</h2>
<p>There is one use case where VLA could come in handy: dynamically allocating multi-dimensional arrays where the inner dimensions are not known until runtime. It isn&rsquo;t even so unsafe as there&rsquo;s no arbitrary stack allocation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">)[</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">malloc</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">A</span><span class="p">));</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="o">`</span><span class="n">n</span><span class="o">`</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="o">`</span><span class="n">m</span><span class="o">`</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">dimensions</span><span class="w">
</span><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w">
</span><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span><span class="w">
</span><span class="w">    </span><span class="nf">free</span><span class="p">(</span><span class="n">A</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="err">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The VLA-free alternatives are either:</p>
<ul>
<li>
<p>piecemeal allocation with <code>malloc()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">int** A = malloc(n * sizeof(*A));
if (A) {
    for (int i = 0; i &lt; m; ++i) {
        A[i] = malloc(m * sizeof(*A[i]));
    }
    // A[i][j] = ...
    for (int i = 0; i &lt; m; ++i) {
        free(A[i]);
    }
    free(A);
}
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>1D array with offsets</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">int* A = malloc(n * m * sizeof(*A));
if (A) {
    // A[i*n + j] = ...
    free(A);
}
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>big fixed array</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">int A[SAFE_SIZE][SAFE_SIZE]; // SAFE_SIZE must be safe for SAFE_SIZE*SAFE_SIZE
// A[i][j] = ...;
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>In short, <strong>avoid VLA</strong>. It poses dangers without giving anything really useful in return (beside in one situation). If you really need to use one, remember about its limitations.</p>
<p>It&rsquo;s probably also worth mentioning that VLAs were supposed to be a solution to even more problematic (non-standard) <code>alloca()</code>.</p>
<p>And for the very end, an example of vla lacking all those problems: <a href="https://en.wikipedia.org/wiki/Vla"><img src="https://upload.wikimedia.org/wikipedia/commons/b/bb/Chocoladevla.jpg" alt="Chocolate vla"></a></p>
<p>&mdash;EOF&mdash;</p>
<p><em>EOF</em>是一个计算机术语，为<code>End Of File</code>的缩写，在操作系统中表示资料源无更多的资料可读取。通常在文本的最后存在此字符表示资料结束。</p>
<p>本人公众号<code>火山灰</code>，亦可搜<code>time_ash_past</code>。</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">总舵主</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2018-01-31
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechat-pay.jpg">
        <span>Wechat</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/pulic.jpg">
        <span>Public Service Account</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="/en/tags/c/">C</a>
          <a href="/en/tags/ruan/">ruan</a>
          <a href="/en/tags/%E7%BF%BB%E8%AF%91/">翻译</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/en/post/%E7%BC%96%E7%A8%8B%E4%B8%96%E7%95%8C/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%85%A5%E9%97%A8/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">A Visual Guide to Version Control</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/en/post/%E7%BF%BB%E8%AF%91%E6%96%87%E7%AB%A0/%E5%88%98%E6%85%88%E6%AC%A3%E4%B8%89%E4%BD%93%E5%BA%8F/">
            <span class="next-text nav-default">AUTHOR’S POSTSCRIPT FOR THE AMERICAN EDITION</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

<ul>...</ul>
</div>


  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "sanbeichahegongheguo/sanbeichahegongheguo.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  


<a href="/en/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        总舵主
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>



  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css"
    integrity="sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG"
    crossorigin="anonymous">

  
  <script defer
    src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js"
    integrity="sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1"
    crossorigin="anonymous"></script>

  
  <script defer
    src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js"
    integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI"
    crossorigin="anonymous" onload="renderMathInElement(document.body);">
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
        
      });
    });
  </script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
